<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tambah Kegiatan - Desa KarangHarja</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #1e40af;
      --primary-light: #3b82f6;
      --primary-dark: #1e3a8a;
      --secondary: #10b981;
      --danger: #dc2626;
      --light: #f9fafb;
      --dark: #111827;
      --gray: #6b7280;
      --white: #ffffff;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--light);
      color: var(--dark);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* NAVBAR */
    .navbar {
      background-color: var(--white);
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      position: fixed;
      top: 0;
      left: 0; right: 0;
      z-index: 1000;
      padding: 0.75rem 1rem;
    }
    .navbar-container {
      max-width: 1100px; margin: 0 auto; display:flex; align-items:center; justify-content:space-between;
    }
    .navbar-brand { display:flex; align-items:center; gap:0.75rem; text-decoration:none; color:var(--dark); font-weight:600; }
    .navbar-logo { height:34px; }

    .btn { padding:0.55rem 0.9rem; border-radius:8px; display:inline-flex; align-items:center; gap:0.5rem; cursor:pointer; border:none; font-weight:600; }
    .btn-outline { background:transparent; border:1px solid #e5e7eb; color:var(--dark); }
    .btn-primary { background:var(--primary); color:var(--white); }

    /* MAIN */
    .main-content { max-width:900px; margin: 96px auto 48px; padding: 0 1rem; }
    .form-container { background:var(--white); padding:24px; border-radius:12px; box-shadow:0 6px 20px rgba(16,24,40,0.06); }

    .form-header h1 { font-size:20px; display:flex; align-items:center; gap:0.5rem; margin-bottom:16px; }

    .form-group { margin-bottom:16px; }
    label { display:block; margin-bottom:8px; font-weight:600; color:var(--dark); }
    input[type="text"], input[type="date"], .editor-content {
      width:100%; padding:10px 12px; border-radius:8px; border:1px solid #e6e7eb; font-size:14px;
    }
    .editor-content { min-height:180px; outline:none; resize:vertical; font-family: 'Times New Roman', Times, serif; }

    .image-upload-btn { background:var(--primary-light); color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; display:inline-flex; gap:8px; align-items:center; }
    .image-upload-btn:hover { background:var(--primary-dark); }

    .image-preview { margin-top:10px; display:none; }
    .image-preview img { max-width:100%; border-radius:8px; max-height:260px; display:block; }

    .image-info { font-size:13px; color:var(--gray); margin-top:6px; }

    .checkbox-group { display:flex; align-items:center; gap:8px; margin-top:6px; }

    .loading { display:none; justify-content:center; padding:10px 0; }
    .loading-spinner { width:28px; height:28px; border:4px solid rgba(59,130,246,0.2); border-top-color:var(--primary); border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }

    .error-message { display:none; margin-top:10px; background:rgba(220,38,38,0.06); color:var(--danger); padding:10px; border-radius:8px; align-items:center; gap:8px; }

    .form-actions { display:flex; justify-content:flex-end; gap:12px; margin-top:18px; flex-wrap:wrap; }
    @media (max-width:640px) {
      .form-actions { flex-direction:column-reverse; }
      .btn { width:100%; justify-content:center; }
    }
  </style>
</head>
<body>
  <!-- NAV -->
  <nav class="navbar">
    <div class="navbar-container">
      <a class="navbar-brand" href="#">
        <img class="navbar-logo" src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/logoterbaru-kgQaweRbiUUGoGKhzIEJcXSvBx7mcU.png" alt="Logo">
        Tambah Kegiatan
      </a>
      <div>
        <a href="dashboard.html" class="btn btn-outline"><i data-lucide="arrow-left"></i> Kembali</a>
      </div>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="main-content">
    <div class="form-container">
      <div class="form-header">
        <h1><i data-lucide="calendar-plus"></i> <span id="formTitle">Tambah Kegiatan Baru</span></h1>
      </div>

      <form id="activityForm" autocomplete="off">
        <div class="form-group">
          <label for="title">Judul Kegiatan</label>
          <input id="title" type="text" placeholder="Masukkan judul kegiatan" required>
        </div>

        <div class="form-group">
          <label for="date">Tanggal Kegiatan</label>
          <input id="date" type="date" required>
        </div>

        <div class="form-group">
          <label for="image">Gambar Kegiatan (Opsional)</label>
          <div class="image-upload-container">
            <input id="image" type="file" accept="image/*" style="display:none;">
            <button type="button" class="image-upload-btn" id="pickImageBtn"><i data-lucide="image"></i> Pilih Gambar</button>
            <div class="image-preview" id="imagePreview">
              <img id="previewImage" src="" alt="Preview">
              <div class="image-info" id="imageInfo"></div>
            </div>
          </div>
        </div>

        <!-- Enhanced editor toolbar (simple) -->
        <div class="form-group">
          <label for="content">Deskripsi Kegiatan</label>
          <div style="display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap;">
            <button type="button" class="btn btn-outline" data-cmd="bold"><i data-lucide="bold"></i></button>
            <button type="button" class="btn btn-outline" data-cmd="italic"><i data-lucide="italic"></i></button>
            <button type="button" class="btn btn-outline" data-cmd="underline"><i data-lucide="underline"></i></button>
            <button type="button" class="btn btn-outline" data-cmd="insertUnorderedList"><i data-lucide="list"></i></button>
            <button type="button" class="btn btn-outline" data-cmd="insertOrderedList"><i data-lucide="list-ordered"></i></button>
          </div>
          <div id="content" class="editor-content" contenteditable="true" placeholder="Tulis deskripsi kegiatan di sini..."></div>
        </div>

        <div class="checkbox-group">
          <input id="published" type="checkbox">
          <label for="published">Publikasikan langsung</label>
        </div>

        <div class="error-message" id="errorMessage"><i data-lucide="alert-circle"></i><span id="errorText"></span></div>
        <div class="loading" id="loading"><div class="loading-spinner"></div></div>

        <div class="form-actions">
          <a href="dashboard.html" class="btn btn-outline"><i data-lucide="x"></i> Batal</a>
          <button id="submitBtn" type="submit" class="btn btn-primary"><i data-lucide="save"></i> <span id="submitText">Posting Kegiatan</span></button>
        </div>
      </form>
    </div>
  </main>

  <!-- Firebase libs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>

  <!-- Lucide icons JS (must be loaded before calling createIcons) -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <script>
    // --- Firebase config (ganti kalau perlu) ---
    const firebaseConfig = {
      apiKey: "AIzaSyC0AcdsPrAQxttVk1SBfBcZnF6tYg4y6GM",
      authDomain: "desakarangharja-31525.firebaseapp.com",
      databaseURL: "https://desakarangharja-31525-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "desakarangharja-31525",
      storageBucket: "desakarangharja-31525.firebasestorage.app",
      messagingSenderId: "428460519406",
      appId: "1:428460519406:web:fca8b9854de78cac5628ff"
    };

    // --- Init Firebase once ---
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.database();

    // --- Helper UI funcs ---
    function showError(msg) {
      const el = document.getElementById('errorMessage');
      document.getElementById('errorText').textContent = msg;
      el.style.display = 'flex';
      setTimeout(()=> { el.style.display = 'none'; }, 6000);
    }

    function setLoading(isLoading) {
      document.getElementById('loading').style.display = isLoading ? 'flex' : 'none';
      document.getElementById('submitBtn').disabled = isLoading;
    }

    // --- Image compression & conversion ---
    function compressImage(file, maxWidth = 1200, quality = 0.75) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onerror = () => reject(new Error('Gagal membaca file gambar'));
        reader.onload = () => {
          const img = new Image();
          img.onerror = () => reject(new Error('Gagal memuat gambar'));
          img.onload = () => {
            const ratio = Math.min(1, maxWidth / img.width);
            const canvas = document.createElement('canvas');
            canvas.width = Math.round(img.width * ratio);
            canvas.height = Math.round(img.height * ratio);
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            canvas.toBlob((blob) => {
              if (blob) resolve(blob);
              else reject(new Error('Gagal mengkompres gambar'));
            }, 'image/jpeg', quality);
          };
          img.src = reader.result;
        };
        reader.readAsDataURL(file);
      });
    }

    function blobToBase64(blob) {
      return new Promise((res, rej) => {
        const r = new FileReader();
        r.onload = () => res(r.result);
        r.onerror = () => rej(new Error('Konversi base64 gagal'));
        r.readAsDataURL(blob);
      });
    }

    // --- Main logic after DOM loaded ---
    document.addEventListener('DOMContentLoaded', () => {
      // initialize lucide icons
      if (typeof lucide !== 'undefined' && lucide.createIcons) {
        lucide.createIcons();
      }

      const urlParams = new URLSearchParams(window.location.search);
      const editId = urlParams.get('edit'); // ?edit=<id> untuk mode edit

      const titleInput = document.getElementById('title');
      const dateInput = document.getElementById('date');
      const contentDiv = document.getElementById('content');
      const publishedInput = document.getElementById('published');
      const imageInput = document.getElementById('image');
      const pickImageBtn = document.getElementById('pickImageBtn');
      const imagePreview = document.getElementById('imagePreview');
      const previewImage = document.getElementById('previewImage');
      const imageInfo = document.getElementById('imageInfo');
      const submitBtn = document.getElementById('submitBtn');
      const submitTextSpan = document.getElementById('submitText');

      let currentImageBase64 = ''; // akan disimpan di db jika ada

      // Protect route: pastikan user login dan email sesuai
      auth.onAuthStateChanged(user => {
        if (!user) {
          alert('Anda belum login, mohon login terlebih dahulu.');
          window.location.href = 'login.html';
          return;
        }
        // contoh pembatasan: hanya email organisasi
        const allowedEmail = 'karangharja2025@gmail.com';
        if (!user.email || user.email.toLowerCase() !== allowedEmail) {
          alert('Akses ditolak: bukan akun yang berwenang.');
          window.location.href = 'login.html';
          return;
        }

        // jika edit mode, load data
        if (editId) {
          document.getElementById('formTitle').textContent = 'Edit Kegiatan';
          submitTextSpan.textContent = 'Update Kegiatan';
          db.ref(`activities/${editId}`).once('value').then(snap => {
            const data = snap.val();
            if (!data) {
              showError('Data kegiatan tidak ditemukan.');
              return;
            }
            titleInput.value = data.title || '';
            dateInput.value = data.date || '';
            contentDiv.innerHTML = data.content || '';
            publishedInput.checked = !!data.published;
            if (data.imageBase64) {
              currentImageBase64 = data.imageBase64;
              previewImage.src = data.imageBase64;
              imageInfo.textContent = 'Gambar tersimpan';
              imagePreview.style.display = 'block';
            }
          }).catch(err => {
            console.error(err);
            showError('Gagal memuat data kegiatan: ' + (err.message || err));
          });
        }
      });

      // Toolbar simple execCommand buttons
      document.querySelectorAll('[data-cmd]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const cmd = btn.getAttribute('data-cmd');
          document.execCommand(cmd, false, null);
          contentDiv.focus();
        });
      });

      // image pick handling
      pickImageBtn.addEventListener('click', () => imageInput.click());
      imageInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        try {
          imagePreview.style.display = 'block';
          imageInfo.textContent = 'Mengkompres gambar...';
          // kompres terlebih dahulu
          let blob = await compressImage(file, 1200, 0.75);
          // jika masih besar (>600KB) coba lagi dengan quality lebih rendah
          if (blob.size > 600 * 1024) {
            blob = await compressImage(file, 1000, 0.6);
          }
          if (blob.size > 800 * 1024) {
            throw new Error('Gambar terlalu besar setelah kompresi. Gunakan gambar yang lebih kecil.');
          }
          currentImageBase64 = await blobToBase64(blob);
          previewImage.src = currentImageBase64;
          imageInfo.textContent = `Ukuran: ${(blob.size / 1024).toFixed(1)} KB`;
        } catch (err) {
          console.error(err);
          currentImageBase64 = '';
          imagePreview.style.display = 'block';
          previewImage.src = '';
          imageInfo.textContent = 'Gagal memuat gambar: ' + (err.message || err);
          showError('Gagal memproses gambar: ' + (err.message || ''));
        }
      });

      // Form submit
      document.getElementById('activityForm').addEventListener('submit', async (ev) => {
        ev.preventDefault();
        // ambil nilai
        const title = titleInput.value.trim();
        const date = dateInput.value;
        const content = contentDiv.innerHTML.trim();
        const published = publishedInput.checked;

        if (!title || !date || !content) {
          showError('Harap isi judul, tanggal, dan deskripsi.');
          return;
        }

        try {
          setLoading(true);
          submitTextSpan.textContent = editId ? 'Memperbarui...' : 'Memproses...';

          const activityData = {
            title,
            date,
            content,
            published,
            updatedAt: firebase.database.ServerValue.TIMESTAMP
          };

          if (!editId) {
            activityData.createdAt = firebase.database.ServerValue.TIMESTAMP;
            activityData.views = 0;
          }

          if (currentImageBase64) {
            activityData.imageBase64 = currentImageBase64;
          }

          if (editId) {
            await db.ref(`activities/${editId}`).update(activityData);
            alert('Kegiatan berhasil diupdate.');
          } else {
            const newRef = await db.ref('activities').push(activityData);
            console.log('Created activity ID:', newRef.key);
            alert('Kegiatan berhasil diposting.');
          }

          // redirect ke dashboard
          window.location.href = 'dashboard.html';
        } catch (err) {
          console.error('Save error', err);
          showError('Gagal menyimpan: ' + (err.message || err));
        } finally {
          setLoading(false);
          submitTextSpan.textContent = editId ? 'Update Kegiatan' : 'Posting Kegiatan';
          // refresh icons (in case button icons changed)
          if (typeof lucide !== 'undefined' && lucide.createIcons) lucide.createIcons();
        }
      });

      // ensure lucide icons exist for dynamic elements
      if (typeof lucide !== 'undefined' && lucide.createIcons) {
        lucide.createIcons();
      }
    });
  </script>
</body>
</html>
